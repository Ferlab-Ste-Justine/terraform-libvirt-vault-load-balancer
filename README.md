# About

This is a terraform module that provisions an haproxy load balancer for a hashicorp vault cluster.

It is dependent on a dns server to resolve members of the vault cluster.

Also, while it doesn't handle tls termination for vault traffic, it requires valid client tls credentials to perform health checks on the vault api to determine the active node if client authentication is turned on (see **tls** variable.)

# Usage

## Input

The module takes the following variables as input:

- **name**: Name of the vm
- **vcpus**: Number of vcpus to assign to the vm. Defaults to 1.
- **memory**: Amount of memory to assign to the vm in MiB. Defaults to 512.
- **volume_id**: Id of the disk volume to attach to the vm.
- **libvirt_network**: Parameters to connect to libvirt networks. Each entry has the following keys:
  - **network_id**: Id (ie, uuid) of the libvirt network to connect to (in which case **network_name** should be an empty string).
  - **network_name**: Name of the libvirt network to connect to (in which case **network_id** should be an empty string).
  - **ip**: Ip of interface connecting to the libvirt network.
  - **mac**: Mac address of interface connecting to the libvirt network.
  - **prefix_length**:  Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be **24**.
  - **gateway**: Ip of the network's gateway. Usually the gateway the first assignable address of a libvirt's network.
  - **dns_servers**: Dns servers to use. Usually the dns server is first assignable address of a libvirt's network.
- **macvtap_interfaces**: List of macvtap interfaces to connect the vm to if you opt for macvtap interfaces. Each entry in the list is a map with the following keys:
  - **interface**: Host network interface that you plan to connect your macvtap interface with.
  - **prefix_length**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be 24.
  - **ip**: Ip associated with the macvtap interface. 
  - **mac**: Mac address associated with the macvtap interface
  - **gateway**: Ip of the network's gateway for the network the interface will be connected to.
  - **dns_servers**: Dns servers for the network the interface will be connected to. If there aren't dns servers setup for the network your vm will connect to, the ip of external dns servers accessible accessible from the network will work as well.
- **cloud_init_volume_pool**: Name of the volume pool that will contain the cloud-init volume of the vm.
- **cloud_init_volume_name**: Name of the cloud-init volume that will be generated by the module for your vm. If left empty, it will default to ``<vm name>-cloud-init.iso``.
- **ssh_admin_user**: Username of the default sudo user in the image. Defaults to **ubuntu**.
- **admin_user_password**: Optional password for the default sudo user of the image. Note that this will not enable ssh password connections, but it will allow you to log into the vm from the host using the **virsh console** command.
- **ssh_admin_public_key**: Public part of the ssh key that will be used to login as the admin on the vm.
- **chrony**: Optional chrony configuration for when you need a more fine-grained ntp setup on your vm. It is an object with the following fields:
  - **enabled**: If set to false (the default), chrony will not be installed and the vm ntp settings will be left to default.
  - **servers**: List of ntp servers to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#server)
  - **pools**: A list of ntp server pools to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#pool)
  - **makestep**: An object containing remedial instructions if the clock of the vm is significantly out of sync at startup. It is an object containing two properties, **threshold** and **limit** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#makestep)
- **fluentd**: Optional fluentd configuration to securely route logs to a fluentd node using the forward plugin. It has the following keys:
  - **enabled**: If set to false (the default), fluentd will not be installed.
  - **load_balancer_tag**: Tag to assign to logs coming from haproxy
  - **node_exporter_tag** Tag to assign to logs coming from the prometheus node exporter
  - **forward**: Configuration for the forward plugin that will talk to the external fluentd node. It has the following keys:
    - **domain**: Ip or domain name of the remote fluentd node.
    - **port**: Port the remote fluentd node listens on
    - **hostname**: Unique hostname identifier for the vm
    - **shared_key**: Secret shared key with the remote fluentd node to authentify the client
    - **ca_cert**: CA certificate that signed the remote fluentd node's server certificate (used to authentify it)
  - **buffer**: Configuration for the buffering of outgoing fluentd traffic
    - **customized**: Set to false to use the default buffering configurations. If you wish to customize it, set this to true.
    - **custom_value**: Custom buffering configuration to provide that will override the default one. Should be valid fluentd configuration syntax, including the opening and closing ```<buffer>``` tags.
- **container_registry**: Optional parameters to get haproxy image from a custom container registry with username/password authentication. It has the following parameters:
  - **url**: Url of the registry (with the http protocol)
  - **username**: Username you want to connect to the registry as
  - **password**: Password of the user
- **install_dependencies**: Whether cloud-init should install external dependencies (should be set to false if you already provide an image with the external dependencies built-in). Defaults to true.
- **tls**: Tls configuration for secure communication with vault. It has the following keys:
  - **ca_certificate**: Ca certificate to authentify the server.
  - **client_certificate**: Tls certificate to authentify the client.
  - **client_key**: Tls private key to authentify the client.
  - **client_auth**: Whether to turn on client authentication.
- **haproxy**: Haproxy configuration. Takes the following keys:
  - **vault_nodes_max_count**: Maximum expected number of vault nodes
  - **vault_nameserver_ips**: List of nameserver ips that will resolve the domain name of the vault nodes.
  - **vault_domain**: Domain name that will resolve to the vault nodes.
  - **timeouts**: Various timeouts for haproxy. It has the following keys:
    - **connect**: Timeout to establish a new connection
    - **check**: Timeout on the checks that determine which vault node is master
    - **idle**: Timeout on iddle connections, either between haproxy and the client or between haproxy and a vault backend